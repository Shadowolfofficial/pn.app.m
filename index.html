<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PRONOTE</title>
<meta name="theme-color" content="#000000">
<script>
(async function(){
  // --- 1) Tentative d'unregister des service workers + suppression des caches (best-effort)
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations().catch(()=>[]);
      for (const r of regs) {
        try { await r.unregister(); } catch(e){/* ignore */ }
      }
    }
  } catch(e){/* ignore */}

  try {
    if ('caches' in window) {
      const keys = await caches.keys().catch(()=>[]);
      await Promise.all(keys.map(k => caches.delete(k))).catch(()=>{});
    }
  } catch(e){/* ignore */ }

  // --- 2) Supprime la balise manifest si elle est présente dans la page (prévention)
  try {
    const m = document.querySelector('link[rel="manifest"]');
    if (m && m.parentNode) m.parentNode.removeChild(m);
  } catch(e){/* ignore */}

  // --- 3) Forcer un reload réseau une seule fois pour récupérer la nouvelle version du HTML
  if (!location.search.includes('_fresh')) {
    location.replace(location.pathname + (location.search ? '&' : '?') + '_fresh=' + Date.now());
    return; // on recharge et on arrête l'exécution actuelle
  }

  // --- 4) Charger la configuration depuis config.json (fetch no-store pour ignorer le cache)
  let cfg = null;
  try {
    const resp = await fetch('config.json?_=' + Date.now(), { cache: 'no-store', credentials: 'same-origin' });
    if (resp && resp.ok) cfg = await resp.json().catch(()=>null);
  } catch(e){ cfg = null; }

  // Valeurs par défaut si pas de config.json
  const activerRedirection = (cfg && typeof cfg.activerRedirection === 'boolean') ? cfg.activerRedirection : true;
  const activerBlocageHeure = (cfg && typeof cfg.activerBlocageHeure === 'boolean') ? cfg.activerBlocageHeure : false;
  const heureDebutBlocage = (cfg && typeof cfg.heureDebutBlocage === 'number') ? cfg.heureDebutBlocage : 22;
  const heureFinBlocage = (cfg && typeof cfg.heureFinBlocage === 'number') ? cfg.heureFinBlocage : 8;
  const urlRedirection = (cfg && typeof cfg.urlRedirection === 'string') ? cfg.urlRedirection : "https://0421691k.index-education.net/pronote/";

  function estDansPlageHoraire(h) {
    if (heureDebutBlocage < heureFinBlocage) {
      return h >= heureDebutBlocage && h < heureFinBlocage;
    } else {
      return (h >= heureDebutBlocage && h <= 23) || (h >= 0 && h < heureFinBlocage);
    }
  }

  // --- 5) Comportement final
  try {
    const now = new Date();
    const heureActuelle = now.getHours();

    if (activerBlocageHeure && estDansPlageHoraire(heureActuelle)) {
      // page blanche silencieuse
      document.documentElement.style.height = '100%';
      document.body.style.margin = '0';
      document.body.style.height = '100%';
      document.body.innerHTML = '';
      return;
    }

    if (activerRedirection) {
      // redirection avec cache-buster pour forcer fetch réseau
      location.replace(urlRedirection + (urlRedirection.includes('?') ? '&' : '?') + '_t=' + Date.now());
    } else {
      // pas de redirection : on reste sur page blanche (aucun texte visible)
      document.documentElement.style.height = '100%';
      document.body.style.margin = '0';
      document.body.style.height = '100%';
      document.body.innerHTML = '';
    }
  } catch(e){
    // silencieux en cas d'erreur
    console.error(e);
    document.body.innerHTML = '';
  }
})();
</script>
<style>html,body{background:#ffffff;width:100%;height:100%;margin:0}</style>
</head>
<body></body>
</html>
